# 非功能需求（NFR）量化追踪表

> **目的**：将抽象的非功能需求具体化、量化、可验证，确保系统在性能、安全、可扩展性等方面达标。

---

## NFR 追踪矩阵

| NFR ID | 类型 | 需求描述 | 关联 Story | 基准值 | 目标值 | 当前值 | 验证方式 | 状态 | 负责人 | 备注 |
|--------|------|---------|-----------|--------|--------|--------|---------|------|--------|------|
| NFR-PERF-001 | 性能 | 用户登录响应时间 | US-USER-003 | 2.5s | < 1s | 0.8s | Lighthouse CI | ✅ 达标 | @dev-team | - |
| NFR-PERF-002 | 性能 | 支付订单创建响应时间 | US-PAY-001 | 3s | < 2s | 1.8s | APM 监控 | ✅ 达标 | @dev-team | - |
| NFR-PERF-003 | 性能 | 首屏加载时间（PC） | US-CONTENT-001 | 4s | < 2s | 2.3s | WebPageTest | ⚠️ 接近阈值 | @frontend | 需优化图片 |
| NFR-PERF-004 | 性能 | 首屏加载时间（移动端） | US-CONTENT-001 | 6s | < 3s | 3.5s | Lighthouse Mobile | ❌ 未达标 | @frontend | 计划引入懒加载 |
| NFR-SCALE-001 | 可扩展性 | 并发支付处理能力 | US-PAY-002 | 100 TPS | 1000 TPS | 850 TPS | 压力测试 | 🔄 优化中 | @backend | 数据库连接池优化 |
| NFR-SCALE-002 | 可扩展性 | 用户注册并发 | US-USER-001 | 50 TPS | 500 TPS | 520 TPS | JMeter | ✅ 达标 | @backend | - |
| NFR-SEC-001 | 安全 | 密码强度验证 | US-USER-001 | 无限制 | 8 位+大小写+数字 | 已实现 | 单元测试 | ✅ 达标 | @security | - |
| NFR-SEC-002 | 安全 | Token 有效期 | US-USER-003 | 永久 | 2 小时 | 2 小时 | 集成测试 | ✅ 达标 | @security | - |
| NFR-SEC-003 | 安全 | 防暴力破解 | US-USER-003 | 无限制 | 5 次失败锁定 15 分钟 | 已实现 | 手动测试 | ✅ 达标 | @security | - |
| NFR-SEC-004 | 安全 | 敏感数据加密 | US-USER-005 | 明文存储 | TLS 1.3 传输 + AES-256 存储 | 已实现 | 安全审计 | ✅ 达标 | @security | - |
| NFR-AVAIL-001 | 可用性 | 系统可用性（SLA） | 全局 | 95% | 99.5% | 99.2% | APM 监控 | 🔄 优化中 | @devops | 需增加冗余节点 |
| NFR-AVAIL-002 | 可用性 | 数据库故障切换时间 | 全局 | 5 分钟 | < 30 秒 | 45 秒 | 灾备演练 | ⚠️ 接近阈值 | @devops | 考虑主从同步优化 |
| NFR-USABILITY-001 | 易用性 | 新用户完成注册时长 | US-USER-001 | 5 分钟 | < 2 分钟 | 1.8 分钟 | 用户测试 | ✅ 达标 | @ux | - |
| NFR-USABILITY-002 | 易用性 | 支付流程步骤数 | US-PAY-001 | 7 步 | < 4 步 | 3 步 | 流程分析 | ✅ 达标 | @ux | - |
| NFR-COMPAT-001 | 兼容性 | 浏览器支持 | 全局 | 仅 Chrome | Chrome 90+, Firefox 88+, Safari 14+ | 已支持 | 手动测试 | ✅ 达标 | @qa | - |
| NFR-COMPAT-002 | 兼容性 | 移动端响应式布局 | 全局 | 无 | 375x667 ~ 1920x1080 | 已支持 | 设备测试 | ✅ 达标 | @frontend | - |
| NFR-MAIN-001 | 可维护性 | 代码测试覆盖率 | 全局 | 40% | > 80% | 75% | Jest Coverage | 🔄 优化中 | @dev-team | 补充集成测试 |
| NFR-MAIN-002 | 可维护性 | 技术文档完整性 | 全局 | 50% | 100% | 85% | 文档审计 | 🔄 优化中 | @tech-writer | API 文档待补充 |
| NFR-COMPLY-001 | 合规 | GDPR 合规 | US-USER-005 | 不符合 | 符合 | 符合 | 法务审计 | ✅ 达标 | @legal | 已实现数据导出 |
| NFR-COMPLY-002 | 合规 | PIPL 合规（中国） | US-USER-005 | 不符合 | 符合 | 符合 | 法务审计 | ✅ 达标 | @legal | 已实现用户同意书 |

---

## 状态说明

| 状态 | 说明 | 处理策略 |
|------|------|---------|
| ✅ **达标** | 当前值已满足目标值 | 持续监控，避免回归 |
| 🔄 **优化中** | 已识别问题，正在优化 | 跟进优化进度，设定截止日期 |
| ⚠️ **接近阈值** | 当前值接近但未达到目标值（90%-100%） | 优先优化，避免恶化 |
| ❌ **未达标** | 当前值远低于目标值（< 90%） | 阻塞发布，立即修复 |
| 📝 **待验证** | 功能已实现但尚未测试 | 安排测试计划 |

---

## NFR 分类详解

### 1. 性能（Performance）

| 子类别 | 典型指标 | 目标值参考 | 测试工具 |
|--------|---------|-----------|---------|
| 响应时间 | API 响应时间（P95） | < 500ms | Postman, JMeter |
| 页面加载 | 首屏加载时间（FCP） | < 2s | Lighthouse, WebPageTest |
| 吞吐量 | 每秒事务数（TPS） | > 100 TPS | Apache Bench, K6 |
| 资源占用 | CPU 占用率（峰值） | < 70% | Grafana, Prometheus |

### 2. 可扩展性（Scalability）

| 子类别 | 典型指标 | 目标值参考 | 测试方法 |
|--------|---------|-----------|---------|
| 并发能力 | 并发用户数 | 1000+ | 压力测试（JMeter） |
| 数据容量 | 单表最大记录数 | 1000 万+ | 数据库测试 |
| 水平扩展 | 节点增加后性能线性提升 | 80%+ | 集群测试 |

### 3. 安全（Security）

| 子类别 | 典型指标 | 目标值参考 | 验证方式 |
|--------|---------|-----------|---------|
| 认证 | Token 有效期 | 2 小时 | 集成测试 |
| 授权 | RBAC 权限验证 | 100% 覆盖 | 权限测试 |
| 加密 | 传输层加密 | TLS 1.3 | 安全扫描 |
| 防护 | SQL 注入防护 | 0 漏洞 | OWASP ZAP |

### 4. 可用性（Availability）

| 子类别 | 典型指标 | 目标值参考 | 测试方法 |
|--------|---------|-----------|---------|
| SLA | 系统正常运行时间 | 99.5% | APM 监控 |
| 容错 | 单节点故障不影响服务 | 0 秒中断 | 故障注入测试 |
| 恢复时间 | MTTR（平均恢复时间） | < 5 分钟 | 灾备演练 |

### 5. 易用性（Usability）

| 子类别 | 典型指标 | 目标值参考 | 测试方法 |
|--------|---------|-----------|---------|
| 学习曲线 | 新用户完成核心任务时长 | < 5 分钟 | 用户测试 |
| 错误率 | 用户操作错误率 | < 5% | A/B 测试 |
| 满意度 | NPS（净推荐值） | > 50 | 用户调研 |

### 6. 兼容性（Compatibility）

| 子类别 | 典型指标 | 目标值参考 | 测试方法 |
|--------|---------|-----------|---------|
| 浏览器 | 支持的浏览器版本 | 主流浏览器最新 2 个版本 | BrowserStack |
| 设备 | 支持的设备类型 | PC + 移动端 | 真机测试 |
| API 版本 | 向后兼容性 | 至少 2 个大版本 | 回归测试 |

### 7. 可维护性（Maintainability）

| 子类别 | 典型指标 | 目标值参考 | 测试方法 |
|--------|---------|-----------|---------|
| 代码质量 | 测试覆盖率 | > 80% | Jest/Vitest Coverage |
| 文档 | API 文档完整性 | 100% | 文档审计 |
| 技术债务 | SonarQube Debt Ratio | < 5% | 静态分析 |

### 8. 合规（Compliance）

| 子类别 | 典型指标 | 目标值参考 | 验证方式 |
|--------|---------|-----------|---------|
| 数据隐私 | GDPR/PIPL 符合性 | 100% | 法务审计 |
| 安全标准 | 等保三级 / ISO 27001 | 通过认证 | 第三方审计 |
| 行业规范 | PCI DSS（支付卡行业） | 符合 | 合规检测 |

---

## 使用指南

### 1. PRD 阶段（PRD 专家）
在编写用户故事时：
1. 识别该 Story 涉及的 NFR（如登录功能涉及性能、安全）
2. 在本表中记录 NFR，设定基准值和目标值
3. 在模块 PRD 的"模块级非功能需求"章节引用对应 NFR ID

### 2. ARCH 阶段（ARCH 专家）
在设计架构时：
1. 评估 NFR 的可行性（目标值是否合理）
2. 设计技术方案以满足 NFR（如引入缓存优化性能）
3. 更新"验证方式"列（如 Lighthouse CI、压力测试）

### 3. TDD 阶段（TDD 专家）
在实现功能时：
1. 编写 NFR 相关的测试用例（如性能测试、安全测试）
2. 执行测试，更新"当前值"列
3. 若未达标，优化代码并重新测试

### 4. QA 阶段（QA 专家）
在验收测试时：
1. 基于本表执行 NFR 验证
2. 更新"状态"列（达标/未达标）
3. 对于未达标的 NFR，创建缺陷单并阻塞发布

### 5. 发布前 Gate
发布前检查：
- [ ] 所有 P0 Story 关联的 NFR 状态为 ✅ 达标
- [ ] 所有 ❌ 未达标的 NFR 已有修复计划或降级方案
- [ ] 所有 📝 待验证的 NFR 已完成验证

---

## 自动化建议

### 脚本工具
```bash
# 检查 NFR 达标情况
npm run nfr:check-compliance

# 生成 NFR 达标报告
npm run nfr:report

# 检测阻塞性 NFR（未达标且无缓解措施）
npm run nfr:check-blockers
```

### CI/CD 集成
```yaml
# .github/workflows/nfr-check.yml
name: NFR Compliance Check

on:
  pull_request:
    branches: [main]

jobs:
  nfr-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 性能测试
      - name: Lighthouse CI
        run: npm run lighthouse:ci
        env:
          THRESHOLD_FCP: 2000  # 首屏加载 < 2s

      # 安全扫描
      - name: OWASP ZAP
        run: docker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:3000

      # 测试覆盖率
      - name: Jest Coverage
        run: npm run test:coverage
        env:
          COVERAGE_THRESHOLD: 80  # 覆盖率 > 80%

      # 生成 NFR 报告
      - name: NFR Report
        run: npm run nfr:report
```

### 示例输出
```
⚠️  NFR 合规检查结果

阻塞性问题（❌ 未达标）:
  - NFR-PERF-004（移动端首屏加载时间）:
    当前值: 3.5s | 目标值: < 3s
    关联 Story: US-CONTENT-001
    建议: 引入图片懒加载和 CDN 加速

接近阈值（⚠️）:
  - NFR-PERF-003（PC 端首屏加载时间）:
    当前值: 2.3s | 目标值: < 2s
    关联 Story: US-CONTENT-001
    建议: 压缩 JavaScript bundle 大小

优化中（🔄）:
  - NFR-SCALE-001（并发支付处理能力）:
    当前值: 850 TPS | 目标值: 1000 TPS
    进度: 85%
    预计完成: 2025-11-15
```

---

## 与其他文档的关系

```
NFR 追踪表（nfr-tracking.md）
  ├─ 数据来源 → PRD 模块（/docs/prd-modules/{domain}/PRD.md）的"模块级非功能需求"
  ├─ 数据来源 → 主 PRD（/docs/PRD.md）的"非功能需求"
  ├─ 影响 → 架构设计（/docs/ARCH.md）
  ├─ 影响 → 测试计划（/docs/QA.md）
  ├─ 影响 → 发布决策（Release Gate）
  └─ 输出 → 性能监控仪表板（Grafana/DataDog）
```

---

## 常见问题

### Q1: 如何设定合理的目标值？
**A**: 参考以下来源：
1. 行业标准（如 Google 建议首屏加载 < 2.5s）
2. 竞品数据（通过工具测试竞品性能）
3. 用户期望（通过调研了解可接受范围）
4. 技术可行性（与 ARCH 专家评估）

### Q2: NFR 未达标是否一定阻塞发布？
**A**: 分情况处理：
- **Critical NFR**（如安全漏洞、数据泄露风险）→ 必须修复后发布
- **High NFR**（如核心功能性能不达标）→ 必须修复或有降级方案
- **Medium NFR**（如次要功能性能）→ 可记录为技术债务，下版本修复
- **Low NFR**（如文档完整性）→ 不阻塞发布

### Q3: 如何处理 NFR 之间的冲突？
**A**: 常见冲突：
- **性能 vs. 安全**：加密增加性能开销
  - 解决方案：硬件加速、算法优化
- **易用性 vs. 安全**：强密码策略降低用户体验
  - 解决方案：渐进式验证、生物识别
- **可扩展性 vs. 成本**：冗余节点增加成本
  - 解决方案：弹性伸缩、按需付费

---

> 本文件由 PRD、ARCH、TDD、QA 专家协同维护。NFR 是系统质量的基石，必须在每个阶段持续验证和优化。
