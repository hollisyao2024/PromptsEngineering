# 用户角色与故事覆盖矩阵

> **目的**：确保每个用户角色都有完整的功能支撑，快速识别功能空白区域，避免"定义了角色但无对应功能"的问题。

---

## 角色-故事覆盖矩阵

| 功能模块 / Story | Admin<br>（管理员） | User<br>（普通用户） | Guest<br>（访客） | Auditor<br>（审计员） | Merchant<br>（商家） |
|----------------|:------------------:|:-----------------:|:----------------:|:--------------------:|:------------------:|
| **用户管理模块** | | | | | |
| US-USER-001: 用户注册 | - | ✅ | ✅ | - | ✅ |
| US-USER-002: 邮箱验证 | - | ✅ | ✅ | - | ✅ |
| US-USER-003: 用户登录 | ✅ | ✅ | - | ✅ | ✅ |
| US-USER-004: 密码重置 | - | ✅ | ✅ | - | ✅ |
| US-USER-005: 个人资料管理 | ✅ | ✅ | - | 🔍 | ✅ |
| US-USER-006: 用户列表管理 | ✅ | - | - | 🔍 | - |
| US-USER-007: 角色权限配置 | ✅ | - | - | 🔍 | - |
| **支付系统模块** | | | | | |
| US-PAY-001: 创建支付订单 | ⚙️ | ✅ | - | 🔍 | ✅ |
| US-PAY-002: 支付确认 | - | ✅ | - | 🔍 | ✅ |
| US-PAY-003: 退款处理 | ✅ | ✅ | - | 🔍 | ✅ |
| US-PAY-004: 支付历史查询 | ✅ | ✅ | - | 🔍 | ✅ |
| US-PAY-005: 支付配置管理 | ✅ | - | - | 🔍 | - |
| **内容管理模块** | | | | | |
| US-CONTENT-001: 浏览内容列表 | ✅ | ✅ | ✅ | 🔍 | ✅ |
| US-CONTENT-002: 创建内容 | ⚙️ | ✅ | - | - | ✅ |
| US-CONTENT-003: 编辑内容 | ✅ | ✅ | - | - | ✅ |
| US-CONTENT-004: 删除内容 | ✅ | ✅ | - | - | ✅ |
| US-CONTENT-005: 内容审核 | ✅ | - | - | 🔍 | - |
| **通知引擎模块** | | | | | |
| US-NOTIF-001: 接收邮件通知 | ✅ | ✅ | - | ✅ | ✅ |
| US-NOTIF-002: 接收短信通知 | ✅ | ✅ | - | - | ✅ |
| US-NOTIF-003: 站内消息 | ✅ | ✅ | - | - | ✅ |
| US-NOTIF-004: 通知偏好设置 | ✅ | ✅ | - | - | ✅ |
| **分析服务模块** | | | | | |
| US-ANALYTICS-001: 用户行为埋点 | - | ✅ | ✅ | - | ✅ |
| US-ANALYTICS-002: 查看数据报表 | ✅ | - | - | 🔍 | ⚙️ |
| US-ANALYTICS-003: 导出数据 | ✅ | - | - | ✅ | ⚙️ |

---

## 图例说明

| 标识 | 说明 |
|------|------|
| ✅ | **主要使用者** - 该角色是此功能的核心用户 |
| 🔍 | **查看权限** - 该角色仅可查看，不可编辑 |
| ⚙️ | **配置权限** - 该角色可配置或管理该功能 |
| - | **不涉及** - 该功能与此角色无关 |

---

## 角色定义与核心需求

### 1. Admin（管理员）
**描述**：系统管理员，负责平台配置、用户管理、内容审核和数据监控。

**核心需求**：
- 管理所有用户账号（查看、编辑、禁用）
- 配置系统参数（支付网关、通知模板、权限策略）
- 审核用户生成内容（UGC）
- 查看全局数据报表

**覆盖 Story 数**：15 / 25（60%）

---

### 2. User（普通用户）
**描述**：产品核心用户，使用主要功能（注册、登录、支付、内容消费）。

**核心需求**：
- 完成注册/登录流程
- 浏览、搜索、购买商品或服务
- 管理个人资料和订单
- 接收通知和消息

**覆盖 Story 数**：18 / 25（72%）

---

### 3. Guest（访客）
**描述**：未登录用户，可浏览公开内容，但功能受限。

**核心需求**：
- 浏览公开内容（商品列表、文章）
- 注册账号
- 重置密码（通过邮箱）

**覆盖 Story 数**：5 / 25（20%）

---

### 4. Auditor（审计员）
**描述**：合规审计人员，仅查看权限，用于安全审计和合规检查。

**核心需求**：
- 查看用户操作日志
- 查看支付交易记录
- 查看敏感数据访问记录
- 导出审计报告

**覆盖 Story 数**：10 / 25（40%）

---

### 5. Merchant（商家）
**描述**：入驻平台的商家，可发布商品、管理订单、查看销售数据。

**核心需求**：
- 创建和管理商品
- 处理订单和退款
- 查看销售报表
- 接收订单通知

**覆盖 Story 数**：14 / 25（56%）

---

## 覆盖率统计

| 角色 | 主要使用（✅） | 查看权限（🔍） | 配置权限（⚙️） | 总覆盖率 |
|------|--------------|--------------|--------------|---------|
| Admin | 8 | 7 | 3 | **72%** |
| User | 16 | 0 | 0 | **64%** |
| Guest | 5 | 0 | 0 | **20%** |
| Auditor | 0 | 10 | 0 | **40%** |
| Merchant | 12 | 0 | 2 | **56%** |

---

## 使用场景

### 1. PRD 编写阶段
新增 Story 时，在矩阵中标记涉及的角色：
- 确保每个角色的核心需求都有对应 Story
- 避免遗漏关键角色的功能

### 2. PRD 评审阶段
检查矩阵是否存在以下问题：

#### 问题 1：孤儿角色（Orphan Persona）
**定义**：在 PRD 中定义了角色，但矩阵中覆盖率 < 30%。

**示例**：
- 如果 "Auditor" 角色覆盖率仅 10%，说明该角色的核心需求未被充分考虑

**解决方案**：
- 重新评估该角色的必要性
- 补充缺失的 Story

#### 问题 2：功能空白（Feature Gap）
**定义**：某行（Story）所有角色都是 `-`，说明该 Story 可能定义错误。

**示例**：
- 如果 US-XXX-001 所有角色都不涉及，该 Story 可能是冗余的

**解决方案**：
- 删除该 Story 或重新定义

#### 问题 3：角色权限冲突
**定义**：Guest 用户拥有需要登录才能使用的功能。

**示例**：
- US-PAY-001（创建订单）标记为 Guest ✅，但订单需要绑定用户账号

**解决方案**：
- 修正权限标记或调整 Story 逻辑

---

### 3. 功能优先级评估
当资源有限时，优先实施：
- 覆盖**核心角色**（如 User）的 Story
- 覆盖**多个角色**的 Story（高复用价值）

**示例**：
- US-USER-003（登录）覆盖 4 个角色 → 高优先级
- US-ANALYTICS-003（导出数据）仅覆盖 2 个角色 → 中优先级

---

### 4. 测试用例设计
QA 专家基于矩阵设计测试用例：
- 为每个 ✅ 标记的组合设计正向测试（如 User 登录成功）
- 为每个 `-` 标记的组合设计负向测试（如 Guest 尝试访问管理后台）

---

## 自动化建议（可选）

### 脚本工具
```bash
# 检查孤儿角色（覆盖率 < 30%）
npm run persona:check-orphans

# 生成角色覆盖报告
npm run persona:coverage-report

# 检查权限冲突（如 Guest 拥有高权限功能）
npm run persona:check-conflicts
```

### 示例输出
```
⚠️  角色覆盖分析

孤儿角色警告:
  - Auditor: 覆盖率 40%（10/25 Story）
    建议: 如该角色为必需，补充审计相关 Story（如操作日志、敏感数据访问记录）

功能空白警告:
  - US-ADMIN-007（系统日志管理）: 所有角色都标记为 "-"
    建议: 确认该 Story 是否需要删除或重新定义角色

权限冲突警告:
  - US-PAY-001（创建订单）: Guest 标记为 ✅，但该功能需要登录
    建议: 修正为 Guest "-"，或调整为"游客下单"逻辑
```

---

## 与其他文档的关系

```
角色-故事矩阵（persona-story-matrix.md）
  ├─ 数据来源 → PRD 模块（/docs/prd-modules/*.md）的用户故事
  ├─ 数据来源 → 主 PRD（/docs/PRD.md）的角色定义
  ├─ 影响 → 权限设计（/docs/ARCH.md 的安全视图）
  ├─ 影响 → 测试用例设计（/docs/QA.md）
  └─ 影响 → UI/UX 设计（不同角色的界面差异）
```

---

## 扩展：权限矩阵（RBAC）

基于本矩阵，ARCH 专家可设计详细的 RBAC 权限表：

| 资源 | Admin | User | Guest | Auditor | Merchant |
|------|:-----:|:----:|:-----:|:-------:|:--------:|
| user:create | ✅ | - | - | - | - |
| user:read | ✅ | 🔒 Self | - | ✅ | 🔒 Self |
| user:update | ✅ | 🔒 Self | - | - | 🔒 Self |
| user:delete | ✅ | 🔒 Self | - | - | - |
| payment:create | ⚙️ | ✅ | - | - | ✅ |
| payment:refund | ✅ | 🔒 Own | - | - | 🔒 Own |
| content:moderate | ✅ | - | - | - | - |

**图例**：
- ✅ 全部权限
- 🔒 Self: 仅限自己的数据
- 🔒 Own: 仅限自己拥有的资源
- ⚙️ 配置权限

---

> 本文件由 PRD 专家维护，ARCH 专家在设计权限系统时引用。每次新增角色或 Story 时应同步更新本矩阵。
