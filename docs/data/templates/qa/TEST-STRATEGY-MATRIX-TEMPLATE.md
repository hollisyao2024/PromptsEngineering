# 全局测试策略矩阵模板

> **说明**：本文件定义全局测试策略，映射 Story → 测试类型的覆盖关系，确保每个用户故事都有明确的测试计划。
>
> **维护者**：QA 专家
> **创建日期**：2025-11-06
> **版本**：v1.0

---

## 数据来源与阶段对齐
为确保全局测试策略紧贴 PRD/ARCH/TASK 各阶段，请按照下列规则填表：
- “Story / Story 标题 / 优先级”与优先级列：从 `/docs/PRD.md` 或模块化的 `/docs/prd-modules/{domain}/PRD.md` 中引用已确认的 Story ID、AC 与 P0~P4 优先级。
- “测试类型”“覆盖目标”“工具推荐”：结合 `/docs/ARCH.md` 或 `/docs/arch-modules/{domain}/ARCH.md` 中的组件/接口/契约、所选技术栈以及架构质量属性（如异步消息、微服务、核心路径）。
- “执行轮次/环境”或“测试策略分配规则”部分：参考 `/docs/TASK.md`（或模块化 TASK）中的里程碑、Owner、执行窗口、环境准备状态，确保策略与实际任务计划同步。
- 策略调整后请同步 `/docs/data/traceability-matrix.md`，记录 Story → Test Case → 测试类型的映射与状态。

## 1. 测试类型定义

### 1.1 测试类型分类

| 测试类型 | 英文名称 | 测试层级 | 执行方式 | 覆盖目标 | 工具推荐 |
|---------|---------|---------|---------|---------|---------|
| **单元测试** | Unit Test | L1（代码层） | 自动化 | 函数/方法级逻辑正确性 | Jest, Vitest, pytest |
| **集成测试** | Integration Test | L2（模块间） | 自动化 | 模块接口契约与数据流 | Supertest, Pact |
| **E2E 测试** | End-to-End Test | L3（系统层） | 自动化 | 用户完整流程与 UI 交互 | Playwright, Cypress |
| **回归测试** | Regression Test | L3（系统层） | 自动化 | 确保新变更不破坏已有功能 | 基于已有测试集 |
| **契约测试** | Contract Test | L2（服务间） | 自动化 | 微服务间接口契约一致性 | Pact, Spring Cloud Contract |
| **降级策略测试** | Degradation Test | L2/L3 | 手动+自动化 | 依赖失败时的降级逻辑 | Chaos Engineering 工具 |
| **事件驱动测试** | Event-driven Test | L2（消息层） | 自动化 | 消息队列与事件处理 | Kafka/RabbitMQ 测试工具 |
| **性能测试** | Performance Test | L3（系统层） | 自动化 | 响应时间、吞吐量、并发能力 | k6, JMeter, Gatling |
| **安全测试** | Security Test | L3（系统层） | 手动+工具扫描 | OWASP Top 10、漏洞扫描 | ZAP, Trivy, Snyk |

### 1.2 测试类型适用场景

| 测试类型 | 何时必须 | 何时可选 | 何时不需要 |
|---------|---------|---------|-----------|
| **单元测试** | 复杂业务逻辑、算法、工具函数 | 简单 CRUD | UI 纯展示组件（无逻辑） |
| **集成测试** | 跨模块交互、API 调用 | 单一模块内部 | 完全隔离的功能 |
| **E2E 测试** | 核心用户流程（P0 Story） | P1 Story | P2 Story（可手动验证） |
| **回归测试** | 每次发版（全量或增量） | - | 全新功能（无历史包袱） |
| **契约测试** | 微服务架构 | Monolith 单体应用 | 无服务间调用 |
| **降级策略测试** | 关键依赖（支付、认证等） | 非关键依赖 | 无外部依赖 |
| **事件驱动测试** | 使用消息队列的异步场景 | 同步调用 | 无消息队列 |
| **性能测试** | 高并发场景、关键路径（P0 Story） | P1 Story | P2 功能 |
| **安全测试** | 涉及用户敏感数据、支付、认证 | 内部工具 | 纯展示页面 |

---

## 2. Story → 测试类型覆盖矩阵

### 2.1 用户管理模块（user-management）

| Story ID | Story 标题 | 优先级 | 单元 | 集成 | E2E | 回归 | 契约 | 降级 | 事件 | 性能 | 安全 | 覆盖完整性 |
|---------|-----------|-------|------|------|-----|------|------|------|------|------|------|-----------|
| US-USER-001 | 用户注册 | P0 | ✅ | ✅ | ✅ | ✅ | - | ✅ | ✅ | ✅ | ✅ | 100% (8/9) |
| US-USER-002 | 邮箱验证 | P0 | ✅ | ✅ | ✅ | ✅ | - | ✅ | ✅ | - | ✅ | 88% (7/9) |
| US-USER-003 | 用户登录 | P0 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | - | ✅ | ✅ | 100% (8/9) |
| US-USER-004 | 密码重置 | P1 | ✅ | ✅ | ✅ | ✅ | - | - | ✅ | - | ✅ | 78% (7/9) |
| US-USER-005 | 用户资料编辑 | P1 | ✅ | ✅ | ✅ | ✅ | - | - | - | - | ✅ | 67% (6/9) |

**模块覆盖率总结**：
- **单元测试**：5/5 (100%) ✅
- **集成测试**：5/5 (100%) ✅
- **E2E 测试**：5/5 (100%) ✅
- **回归测试**：5/5 (100%) ✅
- **安全测试**：5/5 (100%) ✅
- **性能测试**：2/5 (40%) ⚠️ — 建议补充 US-USER-004, US-USER-005 的性能测试

### 2.2 支付系统模块（payment-system）

| Story ID | Story 标题 | 优先级 | 单元 | 集成 | E2E | 回归 | 契约 | 降级 | 事件 | 性能 | 安全 | 覆盖完整性 |
|---------|-----------|-------|------|------|-----|------|------|------|------|------|------|-----------|
| US-PAY-001 | 创建订单 | P0 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 100% (9/9) |
| US-PAY-002 | 支付确认 | P0 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 100% (9/9) |
| US-PAY-003 | 支付回调 | P0 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 100% (9/9) |
| US-PAY-012 | 支付失败重试 | P1 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | - | ✅ | 89% (8/9) |
| US-PAY-018 | 订单超时取消 | P1 | ✅ | ✅ | ✅ | ✅ | - | ✅ | ✅ | - | - | 78% (7/9) |

**模块覆盖率总结**：
- **单元测试**：5/5 (100%) ✅
- **集成测试**：5/5 (100%) ✅
- **E2E 测试**：5/5 (100%) ✅
- **契约测试**：4/5 (80%) ⚠️ — 建议补充 US-PAY-018 的定时任务契约
- **降级策略测试**：5/5 (100%) ✅（关键依赖第三方支付网关）

### 2.3 通知引擎模块（notification）

| Story ID | Story 标题 | 优先级 | 单元 | 集成 | E2E | 回归 | 契约 | 降级 | 事件 | 性能 | 安全 | 覆盖完整性 |
|---------|-----------|-------|------|------|-----|------|------|------|------|------|------|-----------|
| US-NOTIF-001 | 发送邮件通知 | P1 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | - | - | 78% (7/9) |
| US-NOTIF-002 | 发送短信通知 | P1 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | - | - | 78% (7/9) |
| US-NOTIF-010 | 推送通知 | P2 | ✅ | ✅ | ❌ | ✅ | ✅ | - | ✅ | - | - | 67% (6/9) |

**模块覆盖率总结**：
- **单元测试**：3/3 (100%) ✅
- **E2E 测试**：2/3 (67%) ⚠️ — US-NOTIF-010 缺少 E2E 测试（移动端推送）
- **性能测试**：0/3 (0%) ❌ — 建议补充邮件/短信批量发送的性能测试

---

## 3. 全局覆盖率统计

### 3.1 按测试类型统计

| 测试类型 | 应覆盖 Story 数 | 已覆盖 Story 数 | 覆盖率 | 状态 | 改进建议 |
|---------|--------------|--------------|--------|------|---------|
| **单元测试** | 13 | 13 | 100% | ✅ 达标 | - |
| **集成测试** | 13 | 13 | 100% | ✅ 达标 | - |
| **E2E 测试** | 13 | 12 | 92% | ⚠️ 接近达标 | 补充 US-NOTIF-010 E2E |
| **回归测试** | 13 | 13 | 100% | ✅ 达标 | - |
| **契约测试** | 8 (仅微服务) | 7 | 88% | ⚠️ 接近达标 | 补充 US-PAY-018 契约 |
| **降级策略测试** | 7 (关键依赖) | 7 | 100% | ✅ 达标 | - |
| **事件驱动测试** | 8 (异步场景) | 8 | 100% | ✅ 达标 | - |
| **性能测试** | 6 (P0 + 关键路径) | 4 | 67% | ⚠️ 需加强 | 补充 USER/NOTIF 模块 |
| **安全测试** | 8 (敏感数据) | 7 | 88% | ⚠️ 接近达标 | 补充 NOTIF 模块 |

**整体覆盖率**：89%（目标：≥ 85%）✅

### 3.2 按优先级统计

| 优先级 | 总 Story 数 | 平均覆盖率 | 状态 | 备注 |
|-------|-----------|----------|------|------|
| **P0** | 6 | 98% | ✅ 优秀 | 关键路径全覆盖 |
| **P1** | 5 | 82% | ✅ 达标 | 个别性能测试缺失 |
| **P2** | 2 | 67% | ⚠️ 可接受 | 非关键功能 |

---

## 4. 测试覆盖空白区域识别

### 4.1 高优先级缺失（必须补充）

| Story ID | 缺失测试类型 | 优先级 | 风险等级 | 补充计划 | 负责人 | 截止日期 |
|---------|------------|-------|---------|---------|--------|---------|
| US-NOTIF-010 | E2E 测试 | P2 | 中 | 补充移动端推送 E2E 测试 | @qa-mobile | 2025-11-15 |
| US-PAY-018 | 契约测试 | P1 | 中 | 定时任务服务契约 | @qa-backend | 2025-11-10 |

### 4.2 中优先级缺失（建议补充）

| 模块 | 缺失测试类型 | 影响 Story | 风险等级 | 补充建议 |
|------|------------|-----------|---------|---------|
| user-management | 性能测试 | US-USER-004, US-USER-005 | 低 | 补充密码重置、资料编辑的并发测试 |
| notification | 性能测试 | 全部 | 中 | 补充批量发送性能测试（邮件/短信） |
| notification | 安全测试 | US-NOTIF-001, 002, 010 | 低 | 补充邮件模板注入、短信轰炸防护测试 |

### 4.3 低优先级缺失（可延后）

- US-USER-005（用户资料编辑）：降级策略测试 — 该功能无关键外部依赖，可延后
- US-PAY-012, US-PAY-018：性能测试 — 非关键路径，可在后续版本补充

---

## 5. 测试策略分配规则

### 5.1 基于 Story 优先级的自动分配

| Story 优先级 | 必须测试类型 | 推荐测试类型 | 可选测试类型 |
|------------|------------|------------|------------|
| **P0** | 单元、集成、E2E、回归、安全 | 性能、降级 | 契约、事件 |
| **P1** | 单元、集成、E2E、回归 | 安全、性能 | 降级、契约 |
| **P2** | 单元、集成、回归 | E2E | 性能、安全 |

### 5.2 基于功能特性的自动分配

| 功能特性 | 必须测试类型 | 示例 Story |
|---------|------------|-----------|
| **涉及用户敏感数据** | 单元、集成、E2E、安全 | US-USER-001（注册）、US-PAY-002（支付） |
| **依赖第三方服务** | 单元、集成、契约、降级 | US-PAY-003（支付回调）、US-NOTIF-001（邮件） |
| **高并发场景** | 单元、集成、E2E、性能 | US-PAY-001（创建订单）、US-USER-003（登录） |
| **异步消息处理** | 单元、集成、事件驱动 | US-USER-002（邮箱验证）、US-PAY-018（订单超时） |
| **微服务架构** | 单元、集成、契约 | 所有跨服务调用 |

### 5.3 基于架构模式的自动分配

| 架构模式 | 额外测试类型 | 说明 |
|---------|------------|------|
| **微服务** | 契约测试 | 确保服务间接口一致性（Consumer-Provider） |
| **事件驱动** | 事件驱动测试 | 验证消息队列、事件处理、Schema 校验 |
| **分布式系统** | 降级策略测试 | 验证服务降级、熔断、限流逻辑 |
| **单体应用** | - | 可省略契约测试 |

---

## 6. 测试策略维护流程

### 6.1 新增 Story 时

1. **PRD 专家**创建 Story（`/docs/PRD.md` 或 `prd-modules/{domain}.md`）
2. **QA 专家**基于以下规则自动映射测试类型：
   - 读取 Story 优先级（P0/P1/P2）
   - 识别功能特性（敏感数据/第三方依赖/高并发/异步等）
   - 参考架构模式（微服务/事件驱动/单体等）
   - 应用"5.1~5.3 分配规则"
3. **QA 专家**更新本文件的"2. Story → 测试类型覆盖矩阵"
4. **QA 专家**在 `traceability-matrix.md` 添加 Story → AC → Test Case 映射

### 6.2 Story 优先级变更时

1. **PRD 专家**更新 `priority-matrix.md`
2. **QA 专家**重新评估测试类型覆盖（基于"5.1 规则"）
3. **QA 专家**更新本文件，必要时补充/移除测试用例

### 6.3 定期审查（每个里程碑完成后）

1. **QA 专家**执行覆盖率统计：`npm run qa:coverage-report`
2. **QA 专家**更新"3. 全局覆盖率统计"
3. **QA 专家**识别"4. 测试覆盖空白区域"
4. **QA 专家**制定补充计划，更新 `test-priority-matrix.md`

---

## 7. 与其他文档的协作关系

### 7.1 输入（上游依赖）

| 文件 | 提供数据 | 用途 |
|------|---------|------|
| `/docs/PRD.md` | Story ID 列表、优先级 | 确定测试范围 |
| `/docs/prd-modules/{domain}/PRD.md` | 模块 Story 详情 | 分模块制定测试策略 |
| `/docs/ARCH.md` | 架构模式（微服务/单体/事件驱动） | 决定是否需要契约/事件驱动测试 |
| `/docs/data/priority-matrix.md` | Story 优先级评分 | 影响测试类型分配 |
| `/docs/data/nfr-tracking.md` | 非功能需求 | 确定性能/安全测试范围 |

### 7.2 输出（下游影响）

| 文件 | 影响内容 | 说明 |
|------|---------|------|
| `/docs/QA.md` | 全局测试策略章节 | 汇总测试类型定义 |
| `/docs/qa-modules/{domain}/QA.md` | 模块测试策略章节 | 按模块展开测试用例 |
| `/docs/data/traceability-matrix.md` | Test Case ID 列表 | 每个测试类型对应多个测试用例 |
| `/docs/data/test-priority-matrix.md` | 测试用例优先级 | 基于测试类型与 Story 优先级计算 |

---

## 8. 自动化工具支持

### 8.1 覆盖率检查

```bash
# 检查 Story → 测试类型覆盖完整性
npm run qa:check-test-strategy-coverage

# 输出：
# ✅ 13/13 Story 已定义测试策略
# ⚠️  US-NOTIF-010 缺少 E2E 测试
# ⚠️  US-PAY-018 缺少契约测试
```

### 8.2 自动生成测试策略（基于规则）

```bash
# 基于 Story 优先级与功能特性，自动推荐测试类型
npm run qa:suggest-test-strategy -- --story=US-NEW-001

# 输出：
# Story: US-NEW-001（用户支付历史查询）
# 优先级: P1
# 推荐测试类型:
# - 单元测试（必须）
# - 集成测试（必须）
# - E2E 测试（必须）
# - 回归测试（必须）
# - 性能测试（推荐，涉及数据库查询）
# - 安全测试（推荐，涉及用户敏感数据）
```

---

## 9. 常见问题

### Q1: 如何决定某个 Story 是否需要性能测试？
**A**: 遵循以下规则：
- **必须**：P0 Story + 高并发场景（如登录、下单、支付）
- **推荐**：P1 Story + 涉及复杂数据库查询、第三方 API 调用
- **可选**：P2 Story 或内部工具

### Q2: 契约测试是否适用于单体应用？
**A**: 不适用。契约测试主要用于微服务架构，确保服务间接口一致性。单体应用可使用集成测试替代。

### Q3: 如何平衡测试覆盖率与测试成本？
**A**:
- **优先保证 P0 Story 的高覆盖率**（≥ 90%）
- **P1 Story 适度覆盖**（≥ 80%）
- **P2 Story 可选覆盖**（≥ 60%）
- **聚焦自动化**：优先投入自动化测试（单元/集成/E2E），减少手动回归成本

### Q4: 测试策略是否需要随项目迭代调整？
**A**: 需要。建议每个里程碑完成后审查一次，调整策略：
- 新增架构模式（如引入消息队列）→ 增加事件驱动测试
- 性能瓶颈频发 → 增加性能测试覆盖
- 安全漏洞频发 → 增加安全测试覆盖

---

## 10. 参考资料

- **主 QA 文档**：[/docs/QA.md](../../QA.md)
- **PRD 优先级矩阵**：[priority-matrix.md](priority-matrix.md)
- **全局追溯矩阵**：[traceability-matrix.md](traceability-matrix.md)
- **NFR 追踪表**：[nfr-tracking.md](nfr-tracking.md)
- **QA 工具说明**：[/scripts/qa-tools/README.md](../../../scripts/qa-tools/README.md)

---

> **维护说明**：本文件由 QA 专家在 Phase 5（QA 验证阶段）初始化，并在每个里程碑完成后审查更新。新增 Story 时，必须同步更新"2. Story → 测试类型覆盖矩阵"。
