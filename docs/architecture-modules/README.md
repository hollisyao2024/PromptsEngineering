# 架构模块化索引

> **说明**：本目录用于存放按功能域拆分的架构文档。当主架构文档 `/docs/ARCHITECTURE.md` 过于庞大时，ARCHITECTURE 专家会将其拆分为主从结构，此文件作为模块索引与命名规范指引。

**维护者**：ARCHITECTURE 专家
**创建日期**：2025-11-05
**模板版本**：v1.8

---

## 何时需要拆分架构文档？

当项目满足以下**任一条件**时，建议采用模块化架构文档：

1. **主架构文档超过 1000 行**
2. **子系统/服务数量超过 8 个**
3. **存在明确的业务域边界**（3+ 个独立领域模型）
4. **多团队并行开发**，需要独立维护不同领域的架构设计
5. **数据模型复杂**（30+ 实体表，跨域数据流）

对于小型项目（< 5 个服务，单一数据库），维护单一 `/docs/ARCHITECTURE.md` 即可。

---

## 命名规范

### 模块文件命名
- **格式**：`{domain}.md`（使用 kebab-case）
- **示例**：
  - `user-management.md` — 用户管理子系统架构
  - `payment-system.md` — 支付系统架构
  - `notification-service.md` — 通知服务架构
  - `data-analytics.md` — 数据分析平台架构

### 组件/服务 ID 规范
- **格式**：`{MODULE}-{类型}-{序号}`
- **类型标识**：
  - `SVC` — Service（服务）
  - `DB` — Database（数据库）
  - `API` — API 端点
  - `JOB` — 后台任务/定时任务
- **示例**：
  - `USER-SVC-001` — 用户管理服务
  - `PAY-DB-001` — 支付数据库
  - `NOTIF-API-001` — 通知 API
  - `ANALYTICS-JOB-001` — 数据分析定时任务

### ADR（架构决策记录）命名
- **格式**：`NNN-{module}-{title}.md`
- **示例**：
  - `001-user-auth-strategy.md` — 用户认证策略
  - `002-payment-database-sharding.md` — 支付数据库分片决策
  - `003-notification-message-queue.md` — 通知消息队列选型

---

## 模块清单

> **维护规则**：ARCHITECTURE 专家在创建/更新模块时，必须同步更新此表格。

| 模块名称 | 文件路径 | 负责团队 | 对应 PRD 模块 | 状态 | 最后更新 |
|---------|---------|---------|--------------|------|---------|
| （示例）用户管理 | [user-management.md](user-management.md) | @team-backend | [prd-modules/user-management.md](../prd-modules/user-management.md) | ✅ 已确认 | 2025-11-05 |
| （示例）支付系统 | [payment-system.md](payment-system.md) | @team-payment | [prd-modules/payment-system.md](../prd-modules/payment-system.md) | 🔄 进行中 | 2025-11-05 |
| （待补充） | - | - | - | - | - |

**状态标识说明**：
- ✅ **已确认**：架构设计已完成并通过评审
- 🔄 **进行中**：正在设计或修订中
- 📝 **待启动**：计划中但尚未开始
- ❌ **已废弃**：不再使用的设计

---

## 标准模块架构文档结构

每个模块架构文档应包含以下章节：

```markdown
# {模块名称}架构文档

> **所属功能域**：[链接到对应 PRD 模块]
> **负责团队**：@team-xxx
> **状态**：📝 草稿 / ✅ 已确认
> **最后更新**：YYYY-MM-DD

---

## 1. 模块概述
- **业务边界**：描述本模块在整个系统中的定位
- **核心职责**：列出 3-5 个核心功能职责
- **关键约束**：技术约束、性能要求、合规要求

## 2. 逻辑视图
### 2.1 领域模型
- **核心实体**：列出主要领域对象（Entity、Value Object）
- **聚合根**：定义聚合边界
- **领域服务**：关键业务逻辑封装

### 2.2 服务/组件划分
- **服务列表**：列出本模块内的服务/组件（ID 格式：{MODULE}-SVC-{序号}）
- **接口定义**：关键 API 契约
- **职责矩阵**：服务与功能映射

## 3. 数据视图
### 3.1 数据模型（ER 图）
- **核心表**：列出主要数据表（ID 格式：{MODULE}-DB-{序号}）
- **关系说明**：表间关系与外键
- **索引策略**：关键索引设计

### 3.2 数据流
- **输入数据**：本模块依赖的外部数据源
- **输出数据**：本模块提供给其他模块的数据
- **数据同步策略**：跨模块数据一致性方案

## 4. 运行视图
### 4.1 部署架构
- **服务部署**：容器化、负载均衡、扩展策略
- **依赖服务**：数据库、缓存、消息队列等基础设施

### 4.2 关键流程（序列图）
- **典型用例**：选取 2-3 个核心用例绘制时序图
- **异常处理**：错误处理与重试机制

## 5. 接口与依赖
### 5.1 对外接口
- **API 端点**：RESTful API / GraphQL / gRPC 接口清单
- **事件发布**：本模块发布的领域事件

### 5.2 依赖关系
- **上游依赖**：本模块依赖的其他模块（含版本/契约）
- **下游消费者**：依赖本模块的其他模块

## 6. 非功能需求（模块级）
### 6.1 性能要求
- **响应时间**：API 响应时间目标（如 P95 < 200ms）
- **吞吐量**：QPS/TPS 指标
- **并发量**：支持的并发用户数

### 6.2 可用性与容错
- **SLA 目标**：本模块可用性目标（如 99.9%）
- **降级策略**：关键依赖不可用时的降级方案
- **熔断机制**：保护机制与恢复策略

### 6.3 安全要求
- **认证授权**：身份验证与权限控制方案
- **数据加密**：传输加密与存储加密
- **审计日志**：关键操作审计要求

## 7. 风险与限制
- **技术债**：已知的技术债务与改进计划
- **性能瓶颈**：潜在性能瓶颈与优化方向
- **扩展限制**：当前设计的扩展限制

## 8. ADR 引用
列出本模块相关的架构决策记录：
- [ADR-001: {标题}](../../adr/001-xxx.md)
- [ADR-002: {标题}](../../adr/002-xxx.md)

## 9. 变更记录
| 版本 | 日期 | 变更类型 | 变更描述 | 负责人 |
|------|------|---------|---------|--------|
| v0.1 | YYYY-MM-DD | 新增 | 初始版本 | @arch-lead |

---

> **维护说明**：本文档由 ARCHITECTURE 专家在 Phase 2 创建并持续维护。当架构设计发生重大变更时，必须同步更新对应的 ADR。
```

---

## 跨模块协作规范

### 与 PRD 专家协作
- **输入**：读取 `/docs/prd-modules/{domain}.md` 对应的 PRD 模块
- **对齐**：确保架构模块与 PRD 模块一一对应（或 N:1 合并小模块）
- **反馈**：若 PRD 边界不清晰，及时反馈给 PRD 专家调整

### 与 TASK 专家协作
- **输出**：TASK 专家基于本模块架构文档拆解任务
- **粒度**：确保架构设计足够细化，便于 TASK 专家制定可执行的 WBS
- **依赖**：明确标注模块间依赖关系，供 TASK 专家制定开发顺序

### 与 TDD 专家协作
- **接口契约**：提供清晰的 API 接口定义与数据模型
- **测试边界**：明确模块边界，便于 TDD 专家编写单元测试与集成测试
- **技术选型**：提供技术栈与框架选型决策（ADR）

### 与 QA 专家协作
- **测试范围**：提供模块边界与关键流程，供 QA 专家制定测试策略
- **非功能需求**：明确性能、安全、可用性指标，供 QA 专家验证
- **风险点**：标注潜在风险点，供 QA 专家重点测试

---

## 模块化工作流

1. **拆分评估**：ARCHITECTURE 专家根据拆分条件，决定是否采用模块化
2. **创建主架构文档**：在 `/docs/ARCHITECTURE.md` 维护总纲与模块索引（< 500 行）
3. **创建模块架构文档**：在本目录下创建 `{domain}.md` 详细设计
4. **更新模块索引**：在本文件的"模块清单"表格中注册新模块
5. **同步 ADR**：为关键架构决策创建 `/docs/adr/NNN-{module}-{title}.md`
6. **评审确认**：与团队评审后，将模块状态更新为"✅ 已确认"

---

## 常见问题

### Q1: 如何决定模块拆分粒度？
**A**: 遵循以下原则：
- **业务内聚**：一个模块对应一个明确的业务域（与 PRD 模块对齐）
- **技术独立**：模块间通过接口/事件通信，避免直接数据库访问
- **团队对齐**：一个模块尽量由一个团队负责
- **大小适中**：单个模块架构文档 < 300 行

### Q2: 模块间依赖如何管理？
**A**:
- **显式声明**：在每个模块的"接口与依赖"章节明确列出
- **版本化**：对外接口需版本化管理（如 API v1/v2）
- **契约测试**：通过契约测试（Contract Testing）保证接口兼容性
- **依赖图谱**：在主架构文档中维护全局依赖关系图

### Q3: 如何处理跨模块的共享组件？
**A**:
- **选项1**：创建独立的"共享/基础设施"模块（如 `shared-infrastructure.md`）
- **选项2**：在主架构文档的"横切关注点"章节统一描述
- **推荐**：优先选项1，便于独立维护与版本控制

### Q4: 小型项目后续如何平滑升级到模块化？
**A**:
1. 保持主 `/docs/ARCHITECTURE.md` 作为单一真相来源
2. 当满足拆分条件时，ARCHITECTURE 专家评估拆分必要性
3. 逐步将主文档章节迁移到模块文档，保留索引与引用
4. 更新 `/docs/CONVENTIONS.md` 与本 README.md

---

## 相关文档

- **主架构文档**：[/docs/ARCHITECTURE.md](../ARCHITECTURE.md)
- **PRD 模块索引**：[/docs/prd-modules/README.md](../prd-modules/README.md)
- **任务模块索引**：[/docs/task-modules/README.md](../task-modules/README.md)
- **ADR 目录**：[/docs/adr/](../adr/)
- **目录规范**：[/docs/CONVENTIONS.md](../CONVENTIONS.md)

---

> **注意**：本索引文件必须与 `/docs/ARCHITECTURE.md` 中的"功能域架构索引"章节保持同步。任何模块的新增、修改、废弃都必须同时更新两处。
